import React, { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import {
    Container,
    Typography,
    Card,
    CardContent,
    Button,
    Box,
    AppBar,
    Toolbar,
    Table,
    TableBody,
    TableCell,
    TableContainer,
    TableHead,
    TableRow,
    Paper,
    Chip,
    Alert,
    Grid,
} from '@mui/material';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import VerifiedIcon from '@mui/icons-material/Verified';
import axios from 'axios';

function RecommendationView() {
    const navigate = useNavigate();
    const { farmerId, soilDataId } = useParams();
    const [farmer, setFarmer] = useState(null);
    const [soilData, setSoilData] = useState(null);
    const [recommendation, setRecommendation] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        fetchData();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [farmerId, soilDataId]);

    const fetchData = async () => {
        try {
            // Fetch farmer, soil data, and generate recommendation
            const farmerRes = await axios.get(`/api/farmers/${farmerId}`);
            const soilRes = await axios.get(`/api/soil-data/${soilDataId}`);

            setFarmer(farmerRes.data);
            setSoilData(soilRes.data);

            // Generate recommendation
            const recRes = await axios.post('/api/recommendations/generate', {
                farmer_id: parseInt(farmerId),
                soil_data_id: parseInt(soilDataId),
            });

            setRecommendation(recRes.data);
        } catch (err) {
            setError(err.response?.data?.detail || 'Failed to load data');
        } finally {
            setLoading(false);
        }
    };

    const getStatus = (value, low, high) => {
        if (value < low) return { label: 'Low', color: 'error' };
        if (value > high) return { label: 'High', color: 'warning' };
        return { label: 'Medium', color: 'success' };
    };



    const parseFertilizers = (name) => {
        if (!name) return [];
        return name.split(',').map(f => {
            const trimmed = f.trim();
            if (trimmed.includes('Urea')) return { name: 'Urea', price: 266 };
            if (trimmed.includes('DAP')) return { name: 'DAP', price: 1350 };
            if (trimmed.includes('MOP')) return { name: 'MOP', price: 1700 };
            return { name: trimmed, price: 1450 };
        });
    };

    if (loading) {
        return (
            <Box sx={{ minHeight: '100vh', backgroundColor: '#000000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Typography className="text-shimmer">Loading recommendations...</Typography>
            </Box>
        );
    }

    return (
        <Box sx={{ minHeight: '100vh', backgroundColor: '#000000' }}>
            <AppBar position="static">
                <Toolbar>
                    <img
                        src="/logo.png"
                        alt="SoilSense Logo"
                        style={{
                            height: '48px',
                            marginRight: '16px',
                            filter: 'drop-shadow(0 0 10px rgba(76, 175, 80, 0.5))'
                        }}
                    />
                    <Typography
                        variant="h6"
                        component="div"
                        sx={{
                            flexGrow: 1,
                            fontWeight: 600,
                            textShadow: '0 0 10px rgba(76, 175, 80, 0.5)'
                        }}
                    >
                        <span className="text-shimmer">Fertilizer Recommendations</span>
                    </Typography>
                    <Button
                        color="inherit"
                        startIcon={<ArrowBackIcon />}
                        onClick={() => navigate('/')}
                    >
                        Back to Dashboard
                    </Button>
                </Toolbar>
            </AppBar>

            <Container maxWidth="lg" sx={{ mt: 4, pb: 4 }}>
                {error && (
                    <Alert severity="error" sx={{ mb: 2, backgroundColor: 'rgba(211, 47, 47, 0.1)' }}>
                        {error}
                    </Alert>
                )}

                {farmer && (
                    <Card className="premium-card" sx={{ mb: 3 }}>
                        <CardContent>
                            <Typography variant="h5" className="text-glow" sx={{ color: '#4CAF50', mb: 1 }}>
                                {farmer.name}
                            </Typography>
                            <Grid container spacing={2}>
                                <Grid item xs={12} md={6}>
                                    <Typography variant="body2" sx={{ color: '#e0e0e0' }}>
                                        <strong>Location:</strong> {farmer.village}, {farmer.district}, {farmer.state}
                                    </Typography>
                                </Grid>
                                <Grid item xs={12} md={6}>
                                    <Typography variant="body2" sx={{ color: '#e0e0e0' }}>
                                        <strong>Field Area:</strong> {farmer.field_area} hectares | <strong>Crop:</strong> {farmer.crop_name} ({farmer.crop_season})
                                    </Typography>
                                </Grid>
                            </Grid>
                        </CardContent>
                    </Card>
                )}

                {/* Soil Analysis Table */}
                {soilData && (
                    <Card className="premium-card" sx={{ mb: 3 }}>
                        <CardContent>
                            <Typography variant="h5" className="text-shimmer" sx={{ mb: 3 }}>
                                Soil Analysis Summary
                            </Typography>
                            <TableContainer component={Paper} sx={{ backgroundColor: '#000000' }}>
                                <Table>
                                    <TableHead>
                                        <TableRow sx={{ '& th': { backgroundColor: 'rgba(76, 175, 80, 0.1)', borderBottom: '2px solid rgba(76, 175, 80, 0.5)' } }}>
                                            <TableCell sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Parameter</TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Current Level</TableCell>
                                            <TableCell align="center" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Status</TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Required (kg/ha)</TableCell>
                                        </TableRow>
                                    </TableHead>
                                    <TableBody>
                                        <TableRow className="border-glow" sx={{ '&:hover': { backgroundColor: 'rgba(76, 175, 80, 0.05)' } }}>
                                            <TableCell sx={{ color: '#fff' }}>Nitrogen (N)</TableCell>
                                            <TableCell align="right" sx={{ color: '#e0e0e0' }}>{soilData.nitrogen || 'N/A'} mg/kg</TableCell>
                                            <TableCell align="center">
                                                <Chip
                                                    label={getStatus(soilData.nitrogen || 0, 20, 40).label}
                                                    color={getStatus(soilData.nitrogen || 0, 20, 40).color}
                                                    size="small"
                                                />
                                            </TableCell>
                                            <TableCell align="right" sx={{ color: '#81C784', fontWeight: 'bold' }}>
                                                {recommendation?.required_nitrogen.toFixed(2) || 'N/A'}
                                            </TableCell>
                                        </TableRow>
                                        <TableRow className="border-glow" sx={{ '&:hover': { backgroundColor: 'rgba(76, 175, 80, 0.05)' } }}>
                                            <TableCell sx={{ color: '#fff' }}>Phosphorus (P)</TableCell>
                                            <TableCell align="right" sx={{ color: '#e0e0e0' }}>{soilData.phosphorus || 'N/A'} mg/kg</TableCell>
                                            <TableCell align="center">
                                                <Chip
                                                    label={getStatus(soilData.phosphorus || 0, 15, 35).label}
                                                    color={getStatus(soilData.phosphorus || 0, 15, 35).color}
                                                    size="small"
                                                />
                                            </TableCell>
                                            <TableCell align="right" sx={{ color: '#81C784', fontWeight: 'bold' }}>
                                                {recommendation?.required_phosphorus.toFixed(2) || 'N/A'}
                                            </TableCell>
                                        </TableRow>
                                        <TableRow className="border-glow" sx={{ '&:hover': { backgroundColor: 'rgba(76, 175, 80, 0.05)' } }}>
                                            <TableCell sx={{ color: '#fff' }}>Potassium (K)</TableCell>
                                            <TableCell align="right" sx={{ color: '#e0e0e0' }}>{soilData.potassium || 'N/A'} mg/kg</TableCell>
                                            <TableCell align="center">
                                                <Chip
                                                    label={getStatus(soilData.potassium || 0, 20, 35).label}
                                                    color={getStatus(soilData.potassium || 0, 20, 35).color}
                                                    size="small"
                                                />
                                            </TableCell>
                                            <TableCell align="right" sx={{ color: '#81C784', fontWeight: 'bold' }}>
                                                {recommendation?.required_potassium.toFixed(2) || 'N/A'}
                                            </TableCell>
                                        </TableRow>
                                        <TableRow className="border-glow" sx={{ '&:hover': { backgroundColor: 'rgba(76, 175, 80, 0.05)' } }}>
                                            <TableCell sx={{ color: '#fff' }}>pH</TableCell>
                                            <TableCell align="right" sx={{ color: '#e0e0e0' }}>{soilData.ph || 'N/A'}</TableCell>
                                            <TableCell align="center">
                                                <Chip
                                                    label={getStatus(soilData.ph || 7, 6, 7.5).label}
                                                    color={getStatus(soilData.ph || 7, 6, 7.5).color}
                                                    size="small"
                                                />
                                            </TableCell>
                                            <TableCell align="right" sx={{ color: '#e0e0e0' }}>-</TableCell>
                                        </TableRow>
                                        {soilData.ec && (
                                            <TableRow className="border-glow" sx={{ '&:hover': { backgroundColor: 'rgba(76, 175, 80, 0.05)' } }}>
                                                <TableCell sx={{ color: '#fff' }}>EC (Conductivity)</TableCell>
                                                <TableCell align="right" sx={{ color: '#e0e0e0' }}>{soilData.ec} dS/m</TableCell>
                                                <TableCell align="center">
                                                    <Chip
                                                        label={soilData.ec < 2 ? 'Normal' : 'High'}
                                                        color={soilData.ec < 2 ? 'success' : 'warning'}
                                                        size="small"
                                                    />
                                                </TableCell>
                                                <TableCell align="right" sx={{ color: '#e0e0e0' }}>-</TableCell>
                                            </TableRow>
                                        )}
                                    </TableBody>
                                </Table>
                            </TableContainer>
                        </CardContent>
                    </Card>
                )}

                {/* Fertilizer Recommendation Table */}
                {recommendation && (
                    <Card className="premium-card" sx={{ mb: 3 }}>
                        <CardContent>
                            <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
                                <Typography variant="h5" className="text-shimmer" sx={{ flexGrow: 1 }}>
                                    Fertilizer Recommendations
                                </Typography>
                                <Chip
                                    icon={<VerifiedIcon />}
                                    label="Govt. Verified Prices"
                                    color="success"
                                    sx={{ fontWeight: 'bold' }}
                                />
                            </Box>

                            <TableContainer component={Paper} sx={{ backgroundColor: '#000000' }}>
                                <Table>
                                    <TableHead>
                                        <TableRow sx={{ '& th': { backgroundColor: 'rgba(76, 175, 80, 0.1)', borderBottom: '2px solid rgba(76, 175, 80, 0.5)' } }}>
                                            <TableCell sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Fertilizer</TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Quantity (kg/ha)</TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Quantity (kg/acre)</TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Price/50kg*</TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Est. Cost</TableCell>
                                            <TableCell sx={{ color: '#4CAF50', fontWeight: 'bold' }}>Application</TableCell>
                                        </TableRow>
                                    </TableHead>
                                    <TableBody>
                                        {parseFertilizers(recommendation.fertilizer_name).map((fert, index) => {
                                            const qtyHa = recommendation.quantity_kg_per_hectare / parseFertilizers(recommendation.fertilizer_name).length;
                                            const qtyAcre = recommendation.quantity_kg_per_acre / parseFertilizers(recommendation.fertilizer_name).length;
                                            const bags = Math.ceil(qtyHa / 50);
                                            const cost = bags * fert.price;

                                            return (
                                                <TableRow
                                                    key={index}
                                                    className="border-glow"
                                                    sx={{ '&:hover': { backgroundColor: 'rgba(76, 175, 80, 0.05)' } }}
                                                >
                                                    <TableCell sx={{ color: '#fff', fontWeight: 'bold' }}>{fert.name}</TableCell>
                                                    <TableCell align="right" sx={{ color: '#e0e0e0' }}>{qtyHa.toFixed(2)}</TableCell>
                                                    <TableCell align="right" sx={{ color: '#e0e0e0' }}>{qtyAcre.toFixed(2)}</TableCell>
                                                    <TableCell align="right" sx={{ color: '#81C784' }}>₹{fert.price}</TableCell>
                                                    <TableCell align="right" sx={{ color: '#81C784', fontWeight: 'bold' }}>₹{cost.toLocaleString()}</TableCell>
                                                    <TableCell sx={{ color: '#e0e0e0' }}>{recommendation.application_timing || 'Basal'}</TableCell>
                                                </TableRow>
                                            );
                                        })}
                                        <TableRow sx={{ backgroundColor: 'rgba(76, 175, 80, 0.15)' }}>
                                            <TableCell colSpan={4} sx={{ color: '#4CAF50', fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                Total Estimated Cost
                                            </TableCell>
                                            <TableCell align="right" sx={{ color: '#4CAF50', fontWeight: 'bold', fontSize: '1.2rem' }}>
                                                ₹{recommendation.estimated_cost?.toLocaleString() || 'N/A'}
                                            </TableCell>
                                            <TableCell></TableCell>
                                        </TableRow>
                                    </TableBody>
                                </Table>
                            </TableContainer>

                            <Box sx={{ mt: 2, p: 2, backgroundColor: 'rgba(76, 175, 80, 0.05)', borderRadius: 1, border: '1px solid rgba(76, 175, 80, 0.2)' }}>
                                <Typography variant="caption" sx={{ color: '#e0e0e0', display: 'flex', alignItems: 'center' }}>
                                    <VerifiedIcon sx={{ fontSize: 16, mr: 0.5, color: '#4CAF50' }} />
                                    *Prices verified from Department of Fertilizers, Ministry of Chemicals and Fertilizers, Govt. of India (NBS Scheme, Dec 2024). Prices may vary by state and dealer.
                                </Typography>
                            </Box>
                        </CardContent>
                    </Card>
                )}

                {/* Analysis & Reasoning */}
                {recommendation?.reasoning && (
                    <Card className="premium-card">
                        <CardContent>
                            <Typography variant="h5" className="text-shimmer" sx={{ mb: 2 }}>
                                Analysis & Reasoning
                            </Typography>
                            <Box
                                sx={{
                                    p: 3,
                                    backgroundColor: 'rgba(76, 175, 80, 0.05)',
                                    borderRadius: 2,
                                    border: '1px solid rgba(76, 175, 80, 0.2)',
                                    whiteSpace: 'pre-wrap',
                                }}
                            >
                                <Typography variant="body1" sx={{ color: '#e0e0e0', lineHeight: 1.8 }}>
                                    {recommendation.reasoning}
                                </Typography>
                            </Box>
                        </CardContent>
                    </Card>
                )}
            </Container>
        </Box>
    );
}

export default RecommendationView;
